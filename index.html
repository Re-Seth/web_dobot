<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dobot Drawing App</title>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600&family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  :root{
    --bg1:#1a0033; --bg2:#330066; --accent:#ff0066; --muted:#a0a0a0;
    --card: rgba(10,0,20,0.9);
  }
  *{box-sizing:border-box}
  body{
    font-family:'Chakra Petch',sans-serif;
    margin:0; 
    color:#FFFFFF; 
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    padding:20px; min-height:100vh;
  }
  .app{
    max-width:1100px; margin:12px auto; padding:22px; border-radius:16px;
    background:var(--card); border:2px solid #330033; box-shadow:0 10px 40px rgba(0,0,0,0.6);
  }
  header{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  h1{font-family:'Press Start 2P',cursive;color:var(--accent); margin:0; font-size:20px; text-shadow:0 0 10px rgba(255,0,100,0.6)}
  .subtitle{color:var(--muted); margin:0 0 8px 0; font-size:14px}
  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  button, select, input[type="file"], input[type="number"]{
    padding:10px 14px; border-radius:12px; border:none; font-weight:600; cursor:pointer; background-color: #333; color: #fff;
  }
  button:disabled { 
    background-color: #404040; 
    color: #aaa; 
    cursor: not-allowed; 
  }
  button.btn-small { padding: 5px 10px; font-size: 12px; }
  .btn-primary{background:linear-gradient(45deg,#ff0066,#ff66cc); color:#fff}
  .btn-secondary{background:linear-gradient(45deg,#3366ff,#6699ff); color:#fff}
  .btn-danger{background:linear-gradient(45deg,#990000,#ff3333); color:#fff}
  /* ‚≠êÔ∏è ‡∏õ‡∏∏‡πà‡∏° Upload to PC (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) */
  .btn-success{background:linear-gradient(45deg,#00cc66,#66ff99); color:#003311}
  
  .row{display:flex; gap:16px; margin-top:16px; flex-wrap:wrap}
  .col{flex:1; min-width:260px}
  .card{
    padding:14px; border-radius:12px; background:rgba(20,0,40,0.6); border:1px solid #330033;
  }
  .status-box{padding:10px;border-radius:8px;margin-bottom:8px;font-weight:700}
  .status-disconnected{background:#330000;color:#ff9999;border:1px solid #ff3333}
  .status-connected{background:#003300;color:#99ff99;border:1px solid #33ff33}
  .status-loading{background:#000033;color:#99b3ff;border:1px solid #3366ff}
  .status-processing {background:#333300;color:#ffff99;border:1px solid #ffff33}
  .status-drawing {background:#330033;color:#ff99ff;border:1px solid #ff33ff}
  .status-paused {background:#003333;color:#99ffff;border:1px solid #33ffff}
  .status-error {background:#330000;color:#ff9999;border:1px solid #ff3333}
  .status-idle {background:#003300;color:#99ff99;border:1px solid #33ff33}
  
  .progress-wrap{margin-top:12px}
  .progress-container{height:18px;background:#220044;border-radius:12px;border:1px solid #330033;overflow:hidden}
  .progress-bar{height:100%; width:0%; background:linear-gradient(90deg,#ff0066,#ff66cc); transition:width .25s ease}
  .progress-meta{display:flex;justify-content:space-between; margin-top:6px; font-size:13px; color:var(--muted)}
  .image-compare{display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; justify-content:center}
  .image-box{background:rgba(10,0,30,0.5); padding:10px;border-radius:10px; border:1px solid #660099; min-width:170px; max-width:320px; text-align:center}
  .image-box img{max-width:100%; border-radius:6px; display:block; margin:8px auto; border:2px solid #9933ff}
  .log-box{
    font-family:monospace; font-size:13px; max-height:220px; overflow:auto; padding:10px; border-radius:8px; 
    background:rgba(20, 20, 20, 0.4); 
    border:1px solid #330033; 
    color:#FFFFFF; 
  }
  .log-line{padding:4px 0; border-bottom:1px dashed rgba(255,255,255,0.05)} 
  .small{font-size:13px; color:var(--muted)}
  .form-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .corner-inputs{ display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
  .corner-group { justify-content: space-between; }
  .corner-group label { min-width: 80px; }
  label{font-size:13px; color:var(--muted)}
  .toast{position:fixed; right:20px; bottom:20px; background:linear-gradient(45deg,#222, #440044); color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.6); display:none; z-index:9999}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:999; padding: 20px;}
  .modal .modal-card{background:var(--card); padding:24px; border-radius:12px; max-width:760px; width:100%; border:1px solid #330033; max-height: 90vh; overflow-y: auto;}
  .modal h2{margin-top:0;color:var(--accent)}
  .modal h3{color:#99aaff; border-bottom: 1px solid #330033; padding-bottom: 8px;}
  .modal li { margin-bottom: 10px; }
  footer{margin-top:18px; text-align:center; color:var(--muted); font-size:13px}
  
  #processingStep2, #processingStep3 {
    margin-top: 12px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px dashed var(--accent);
  }
  
  @media (max-width:760px){
    header{flex-direction:column; align-items:flex-start}
    .row{flex-direction:column}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Dobot Drawing App üé®ü§ñ</h1>
        <p class="subtitle">Convert images to line art for drawing with Dobot Magician</p>
      </div>
      <div style="margin-left:auto" class="controls">
        <button id="quickUploadBtn" class="btn-success">‚òÅÔ∏è Upload to PC</button>
        <button id="helpBtn" class="btn-secondary">Help / QR</button>
      </div>
    </header>

    <div class="row" style="margin-top:12px">
      <div class="col card">
        <div id="statusMessage" class="status-box status-disconnected">Status: Disconnected</div>
        <div id="dobotInfo" style="display:none">
          <div class="small">Model: <strong id="dobotModel">-</strong> &nbsp; | &nbsp; Port: <strong id="dobotPort">-</strong></div>
        </div>
        <div style="margin-top:10px" class="controls">
          <button id="connectBtn" class="btn-primary">Connect Dobot</button>
          <button id="disconnectBtn" class="btn-secondary" disabled>Disconnect</button>
        </div>
        
        <div style="margin-top:10px; border-top: 1px solid #330033; padding-top: 10px;" class="form-group">
          <label class="small">Speed (%):</label>
          <input id="speedInput" type="number" min="1" max="100" value="50" style="width:80px">
          
          <label class="small">Offset (mm):</label>
          <input id="penOffsetInput" type="number" step="0.5" value="0" style="width:80px" title="Pen pressure offset (positive = deeper)">
          
          <label class="small">Safety (mm):</label>
          <input id="safetyHeightInput" type="number" step="0.5" value="20" style="width:80px" title="Height when lifting the pen">
        </div>
        
      </div>
      
      <div class="col card">
        <h3 style="margin:0 0 8px 0">Paper Calibration</h3>
        <p class="small" style="margin-top:0">Move Dobot to the paper corners and press "Set", or enter coordinates manually.</p>
        <div class="corner-inputs">
          <div class="form-group corner-group">
            <label>Top-Left:</label>
            <div>
                <input id="tl_x" type="number" placeholder="X" style="width:80px">
                <input id="tl_y" type="number" placeholder="Y" style="width:80px">
            </div>
            <button id="setTlBtn" class="btn-secondary btn-small" disabled>Set</button>
          </div>
          <div class="form-group corner-group">
            <label>Top-Right:</label>
            <div>
                <input id="tr_x" type="number" placeholder="X" style="width:80px">
                <input id="tr_y" type="number" placeholder="Y" style="width:80px">
            </div>
            <button id="setTrBtn" class="btn-secondary btn-small" disabled>Set</button>
          </div>
          <div class="form-group corner-group">
            <label>Bottom-Left:</label>
            <div>
                <input id="bl_x" type="number" placeholder="X" style="width:80px">
                <input id="bl_y" type="number" placeholder="Y" style="width:80px">
            </div>
            <button id="setBlBtn" class="btn-secondary btn-small" disabled>Set</button>
          </div>
          <div class="form-group corner-group">
            <label>Bottom-Right:</label>
            <div>
                <input id="br_x" type="number" placeholder="X" style="width:80px">
                <input id="br_y" type="number" placeholder="Y" style="width:80px">
            </div>
            <button id="setBrBtn" class="btn-secondary btn-small" disabled>Set</button>
          </div>
        </div>
        <div style="margin-top:12px" class="controls">
          <button id="applyCornersBtn" class="btn-primary" disabled>Apply 4 Corners</button>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col card">
        <h3 style="margin:0 0 8px 0">Upload & Prepare</h3>
        <div class="form-group">
          <input id="imageInput" type="file" accept="image/*">
          </div>
        <div style="margin-top:8px" class="controls">
          <button id="processBtn" class="btn-primary" disabled>1. Process Image</button>
          <button id="drawBtn" class="btn-danger" disabled>3. Start Drawing</button>
        </div>
        
        <div id="processingStep2" style="display:none">
          <label for="paramChoice" class="small">‡∏î‡∏π‡∏†‡∏≤‡∏û 'Comparison' ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
          <div class="controls">
            <input id="paramChoice" type="number" min="1" max="5" value="1" style="width:100px">
            <button id="selectParamBtn" class="btn-primary">2. Generate Paths</button>
          </div>
        </div>
        
        <div id="processingStep3" style="display:none">
          <label for="startContour" class="small">‡∏î‡∏π 'All Steps' ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 1:</label>
          <div class="controls">
            <input id="startContour" type="number" min="1" value="1" style="width:120px">
            <label id="totalContoursLabel" class="small"></label>
          </div>
        </div>

        <div class="image-compare">
          <div class="image-box"><div class="small"><strong>Original</strong></div><img id="originalImagePreview" alt="Original" style="display:none"></div>
          <div class="image-box"><div class="small"><strong>B&W (Processed)</strong></div><img id="lineartImagePreview" alt="B&W" style="display:none"></div>
          <div class="image-box"><div class="small"><strong>Comparison / Vector</strong></div><img id="vectorImagePreview" alt="Vector" style="display:none"></div>
        </div>
      </div>
      
      <div class="col card">
        <h3 style="margin:0 0 8px 0">Drawing Controls & Progress</h3>
        <div class="controls">
          <button id="pauseBtn" class="btn-secondary" disabled>Pause</button>
          <button id="resumeBtn" class="btn-secondary" disabled>Resume</button>
          <button id="stopBtn" class="btn-danger" disabled>Stop</button>
        </div>
        <div style="margin-top:12px" class="progress-wrap">
          <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
          <div class="progress-meta">
            <div id="progressText">Progress: 0%</div>
            <div id="timeMeta" class="small">Elapsed: 0s | ETA: -</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col card">
        <h3 style="margin:0 0 8px 0">Log Console</h3>
        <div id="logBox" class="log-box"></div>
        <div style="margin-top:8px; display:flex; gap:8px; justify-content:space-between; align-items:center">
          <div class="small">Real-time logs from actions</div>
          <div><button id="clearLogBtn" class="btn-secondary">Clear</button><button id="downloadLogBtn" class="btn-secondary">Download</button></div>
        </div>
      </div>
    </div>

    <footer>Dobot Drawing App for Hardware Control</footer>
  </div>

  <div id="toast" class="toast"></div>

  <div id="uploadModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h2>‚òÅÔ∏è Upload Pictures to PC</h2>
      <p style="color:var(--muted)">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå (Server)<br>
        (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á: <code>static/mobile_uploads</code>)
      </p>
      
      <div style="margin-top:20px; text-align:center;">
          <input type="file" id="mobileInput" accept="image/*" multiple style="display:block; margin:0 auto 10px auto;">
          <button id="doUploadBtn" class="btn-success">Upload Now</button>
      </div>
      <p id="uploadStatus" style="text-align:center; margin-top:10px; color:#aaa; font-size:14px;"></p>

      <div style="text-align:right; margin-top:20px">
          <button id="closeUploadBtn" class="btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <div id="helpModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h2>How to Use & Mobile Access</h2>
      
      <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:8px; text-align:center; margin-bottom:20px;">
          <h3 style="margin-top:0; color:#fff;">üì≤ Scan to Open on Mobile</h3>
          <div id="qrcode" style="display:inline-block; background:#fff; padding:10px; border-radius:4px;"></div>
          <p style="margin:10px 0 0 0; font-family:monospace; color:#66ff99;">
             http://{{ server_ip }}:{{ server_port }}
          </p>
          <p class="small">(Make sure your phone is on the same Wi-Fi)</p>
      </div>

      <h3>Basic Instructions</h3>
      <ul style="color:#ddd;line-height:1.6; padding-left:20px">
        <li><strong>Connect:</strong> Connect USB & press 'Connect Dobot'.</li>
        <li><strong>Calibrate:</strong> Move pen to corners & click 'Set'.</li>
        <li><strong>Process:</strong> Upload image -> Process -> Select Style.</li>
        <li><strong>Draw:</strong> Adjust speed/height -> Start Drawing.</li>
      </ul>
      <div style="text-align:right; margin-top:12px"><button id="closeHelpBtn" class="btn-primary">Close</button></div>
    </div>
  </div>


<script>
// --- Globals & Element Refs ---
const toastEl = document.getElementById('toast');
const logBox = document.getElementById('logBox');
const statusMessage = document.getElementById('statusMessage');

const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const applyCornersBtn = document.getElementById('applyCornersBtn');
const processBtn = document.getElementById('processBtn');
const selectParamBtn = document.getElementById('selectParamBtn'); 
const drawBtn = document.getElementById('drawBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const stopBtn = document.getElementById('stopBtn');

const imageInput = document.getElementById('imageInput');
const paramChoiceInput = document.getElementById('paramChoice'); 
const startContourInput = document.getElementById('startContour'); 
const totalContoursLabel = document.getElementById('totalContoursLabel'); 

const processingStep2 = document.getElementById('processingStep2'); 
const processingStep3 = document.getElementById('processingStep3'); 

const originalImagePreview = document.getElementById('originalImagePreview');
const lineartImagePreview = document.getElementById('lineartImagePreview'); 
const vectorImagePreview = document.getElementById('vectorImagePreview'); 

const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const timeMeta = document.getElementById('timeMeta');
const dobInfo = { container: document.getElementById('dobotInfo'), model: document.getElementById('dobotModel'), port: document.getElementById('dobotPort') };

const cornerInputs = {
    tl_x: document.getElementById('tl_x'), tl_y: document.getElementById('tl_y'),
    tr_x: document.getElementById('tr_x'), tr_y: document.getElementById('tr_y'),
    bl_x: document.getElementById('bl_x'), bl_y: document.getElementById('bl_y'),
    br_x: document.getElementById('br_x'), br_y: document.getElementById('br_y'),
};
const setCornerBtns = {
    tl: document.getElementById('setTlBtn'), tr: document.getElementById('setTrBtn'),
    bl: document.getElementById('setBlBtn'), br: document.getElementById('setBrBtn'),
};

let pollingIntervalId = null;
let drawingStartTime = null;
let currentStatus = 'disconnected'; 
let dfcallPollIntervalId = null; 

// --- Utility Functions ---
function showToast(msg, ms = 3000) {
  toastEl.innerText = msg;
  toastEl.style.display = 'block';
  setTimeout(() => { toastEl.style.display = 'none'; }, ms);
}

function addLog(msg) {
  const line = document.createElement('div');
  line.className = 'log-line';
  const now = new Date().toLocaleTimeString();
  line.textContent = `[${now}] ${msg}`;
  logBox.appendChild(line);
  logBox.scrollTop = logBox.scrollHeight;
}
function clearLog() { logBox.innerHTML = ''; addLog('Log cleared.'); }
function downloadLog() {
  const text = Array.from(logBox.querySelectorAll('.log-line')).map(e => e.textContent).join('\n');
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `dobot_log_${new Date().toISOString()}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function formatDuration(sec) {
  if (!sec) return '0s'; if (sec < 60) return `${sec}s`;
  const m = Math.floor(sec/60); const s = sec % 60;
  return `${m}m ${s}s`;
}

// --- API Call Function ---
async function apiPost(path, body = null, isForm = false) {
  try {
    const opts = { method: 'POST' };
    if (isForm) {
        opts.body = body;
    } else {
        opts.headers = { 'Content-Type': 'application/json' };
        opts.body = JSON.stringify(body || {});
    }
    const res = await fetch(path, opts);
    const resJson = await res.json();
    if (!res.ok) {
        const errorMsg = resJson.message || `HTTP ${res.status}`;
        addLog(`[HTTP Error ${res.status}] API ${path} failed: ${errorMsg}`);
        throw new Error(errorMsg);
    }
    return resJson;
  } catch (err) {
    addLog(`[API ERROR] ${path}: ${err.message}`);
    setStatus('error', `API Error: ${err.message}`);
    return { status: 'error', message: err.message };
  }
}

async function apiGet(path) {
  try {
    const res = await fetch(path, {cache: 'no-store'}); 
    const resJson = await res.json();
    if (!res.ok) {
        const errorMsg = resJson.message || `HTTP ${res.status}`;
        addLog(`[HTTP Error ${res.status}] API ${path} failed: ${errorMsg}`);
        throw new Error(errorMsg);
    }
    return resJson;
  } catch (err) {
    addLog(`[API ERROR] ${path}: ${err.message}`);
    setStatus('error', `API Error: ${err.message}`);
    return { status: 'error', message: err.message };
  }
}

function setStatus(statusType, message) {
  if (statusType !== 'processing') stopDfcallPolling();
  if (statusType !== 'drawing' && statusType !== 'paused') stopDrawingPolling();
  
  currentStatus = statusType;
  statusMessage.textContent = 'Status: ' + (message || statusType);
  statusMessage.className = `status-box status-${statusType}`;
  
  const isConnected = statusType === 'connected' || statusType === 'idle' || statusType === 'processing' || statusType === 'drawing' || statusType === 'paused' || statusType === 'error';
  const isIdle = statusType === 'idle' || statusType === 'connected'; 
  const isDrawing = statusType === 'drawing' || statusType === 'paused';
  const isProcessing = statusType === 'processing';
  
  connectBtn.disabled = isConnected;
  disconnectBtn.disabled = !isConnected || isDrawing || isProcessing;
  applyCornersBtn.disabled = !isIdle;
  Object.values(setCornerBtns).forEach(btn => btn.disabled = !isIdle);
  const hasImage = imageInput.files.length > 0;
  processBtn.disabled = !isIdle || !hasImage;
  const hasProcessed = processingStep2.style.display !== 'none';
  selectParamBtn.disabled = !isIdle || !hasProcessed;
  const hasPaths = processingStep3.style.display !== 'none';
  drawBtn.disabled = !isIdle || !hasPaths;
  pauseBtn.disabled = statusType !== 'drawing';
  resumeBtn.disabled = statusType !== 'paused';
  stopBtn.disabled = !isDrawing;
  if (!isIdle) {
      if (!isDrawing) {
          processingStep2.style.display = 'none';
          processingStep3.style.display = 'none';
      }
  }
  if (statusType === 'disconnected') {
      processingStep2.style.display = 'none';
      processingStep3.style.display = 'none';
  }
}

function showProgress(percent, message) {
  if (percent < 0) percent = 0; if (percent > 100) percent = 100;
  progressBar.style.width = percent + '%';
  const etaMatch = message.match(/\| (ETA:.*)/);
  const etaText = etaMatch ? etaMatch[1] : '-';
  const mainMessage = etaMatch ? message.replace(etaMatch[0], '') : message;
  progressText.textContent = `Progress: ${percent.toFixed(1)}% ‚Äî ${mainMessage || ''}`;
  const elapsedSec = drawingStartTime ? Math.floor((Date.now() - drawingStartTime)/1000) : 0;
  timeMeta.textContent = `Elapsed: ${formatDuration(elapsedSec)} | ${etaText}`;
  if (percent >= 100) drawingStartTime = null;
}

function resetProgress() {
  progressBar.style.width = '0%';
  progressText.textContent = 'Progress: 0%';
  timeMeta.textContent = 'Elapsed: 0s | ETA: -';
  drawingStartTime = null;
}

// --- ‚≠êÔ∏è Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal & Upload ‚≠êÔ∏è ---
const uploadModal = document.getElementById('uploadModal');
const helpModal = document.getElementById('helpModal');

document.getElementById('helpBtn').addEventListener('click', ()=> helpModal.style.display='flex');
document.getElementById('closeHelpBtn').addEventListener('click', ()=> helpModal.style.display='none');
helpModal.addEventListener('click',(e)=>{ if(e.target===helpModal) helpModal.style.display='none' });

document.getElementById('quickUploadBtn').addEventListener('click', ()=> {
    uploadModal.style.display='flex';
    document.getElementById('uploadStatus').textContent = ''; 
});
document.getElementById('closeUploadBtn').addEventListener('click', ()=> uploadModal.style.display='none');
uploadModal.addEventListener('click',(e)=>{ if(e.target===uploadModal) uploadModal.style.display='none' });

document.getElementById('doUploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('mobileInput');
    const statusText = document.getElementById('uploadStatus');
    
    if (fileInput.files.length === 0) {
        statusText.textContent = '‚ùå Please select file(s).'; return;
    }

    statusText.textContent = '‚è≥ Uploading...';
    const form = new FormData();
    // Loop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå
    for (let i = 0; i < fileInput.files.length; i++) {
        form.append('images', fileInput.files[i]);
    }
    
    const res = await apiPost('/quick_upload', form, true);
    if (res && res.status === 'success') {
        statusText.textContent = `‚úÖ ${res.message}`;
        statusText.style.color = '#66ff99';
        showToast('Upload complete!');
        addLog(`Mobile upload success: ${res.filenames.length} files`);
    } else {
        statusText.textContent = `‚ùå Failed: ${res ? res.message : 'Error'}`;
        statusText.style.color = '#ff6666';
    }
});

// --- ‚≠êÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚≠êÔ∏è ---
// (‡∏Ñ‡πà‡∏≤ server_ip ‡πÅ‡∏•‡∏∞ server_port ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢ Flask ‡∏ï‡∏≠‡∏ô render)
const serverIP = "{{ server_ip }}"; 
const serverPort = "{{ server_port }}";
if (serverIP && serverPort) {
    const url = `http://${serverIP}:${serverPort}`;
    new QRCode(document.getElementById("qrcode"), {
        text: url,
        width: 128,
        height: 128
    });
    console.log("QR Generated for:", url);
}
// ----------------------------------

connectBtn.addEventListener('click', async () => {
  setStatus('loading', 'Connecting...');
  const res = await apiPost('/connect');
  if (res && res.status.includes('success')) {
    setStatus('idle', res.message || 'Connected');
    dobInfo.container.style.display = 'block'; 
    dobInfo.model.textContent = res.model || 'Unknown'; 
    dobInfo.port.textContent = res.port || '-';
    showToast('Dobot connected');
  } else {
    setStatus('disconnected', res.message || 'Connection failed');
    showToast('Connection failed');
  }
});

disconnectBtn.addEventListener('click', async () => {
  setStatus('loading', 'Disconnecting...'); 
  const res = await apiPost('/disconnect');
  setStatus('disconnected', res.message || 'Disconnected'); 
  dobInfo.container.style.display = 'none';
  showToast('Disconnected');
});

async function setCurrentPositionForCorner(cornerPrefix) {
    if (currentStatus === 'disconnected') { showToast('Error: Please connect Dobot first.'); return; }
    addLog(`Requesting current position for ${cornerPrefix.toUpperCase()}...`);
    const data = await apiGet('/get_position'); 
    if (data.status === 'success') {
        cornerInputs[`${cornerPrefix}_x`].value = data.x;
        cornerInputs[`${cornerPrefix}_y`].value = data.y;
        addLog(`Set ${cornerPrefix.toUpperCase()} to (X: ${data.x}, Y: ${data.y})`);
        showToast(`${cornerPrefix.toUpperCase()} position set!`);
    } else {
        addLog(`Error getting position: ${data.message}`);
        showToast('Error: Could not get position');
    }
}
Object.keys(setCornerBtns).forEach(key => {
    setCornerBtns[key].addEventListener('click', () => setCurrentPositionForCorner(key));
});

applyCornersBtn.addEventListener('click', async () => {
    const corners = {
        tl: [parseFloat(cornerInputs.tl_x.value), parseFloat(cornerInputs.tl_y.value)],
        tr: [parseFloat(cornerInputs.tr_x.value), parseFloat(cornerInputs.tr_y.value)],
        bl: [parseFloat(cornerInputs.bl_x.value), parseFloat(cornerInputs.bl_y.value)],
        br: [parseFloat(cornerInputs.br_x.value), parseFloat(cornerInputs.br_y.value)], 
    };
    for(const key in corners) {
        if(isNaN(corners[key][0]) || isNaN(corners[key][1])) {
            showToast('Error: All corner values must be numbers.'); return;
        }
    }
    setStatus('processing', 'Setting corners...');
    const res = await apiPost('/set_paper_corners', { corners });
    if (res.status?.includes('success')) {
        setStatus('idle', res.message || 'Corners set');
        showToast('4 corners applied');
    } else {
        setStatus('idle', res.message || 'Failed to set corners');
        showToast('Set corners failed');
    }
});

imageInput.addEventListener('change',(e)=>{
  const file = e.target.files[0]; 
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    originalImagePreview.src = ev.target.result; 
    originalImagePreview.style.display = 'block';
    lineartImagePreview.style.display = 'none'; lineartImagePreview.src = '';
    vectorImagePreview.style.display = 'none'; vectorImagePreview.src = '';
    resetProgress();
    addLog('Image selected: ' + file.name);
    processingStep2.style.display = 'none';
    processingStep3.style.display = 'none';
    setStatus(currentStatus, statusMessage.textContent.replace('Status: ', ''));
  };
  reader.readAsDataURL(file);
});

processBtn.addEventListener('click', async () => {
  const file = imageInput.files[0]; 
  if (!file) { alert('Please select an image file first.'); return; }
  lineartImagePreview.style.display = 'none';
  vectorImagePreview.style.display = 'none';
  processingStep2.style.display = 'none';
  processingStep3.style.display = 'none';
  resetProgress(); 
  setStatus('processing', 'Starting DFCall (Step 1/3)...');
  addLog('Started processing image (DFCall)...'); 
  showToast('Processing image... (This may take 20-30s)');
  const form = new FormData();
  form.append('image', file);
  const res = await apiPost('/process_image', form, true);
  if (res?.status?.includes('processing_started')) {
    addLog('DFCall started... Polling for result.');
    setStatus('processing', 'Processing DFCall... (Polling)');
    startDfcallPolling(); 
  } else {
    setStatus('idle', res.message || 'Process start failed');
    addLog('Process start failed: ' + (res.message || JSON.stringify(res))); 
    showToast('Process start failed');
  }
});

function startDfcallPolling() {
  if (dfcallPollIntervalId) clearInterval(dfcallPollIntervalId);
  dfcallPollIntervalId = setInterval(async () => {
      addLog('Polling: Checking DFCall status...');
      const res = await apiGet('/check_processing'); 
      if (res.status === 'processing') {
          setStatus('processing', res.message || 'DFCall is running...');
      } else if (res.status === 'success') {
          stopDfcallPolling();
          addLog('Process success: ' + (res.message || ''));
          const cacheBuster = `?t=${Date.now()}`;
          originalImagePreview.src = res.original_url + cacheBuster;
          originalImagePreview.style.display = 'block';
          lineartImagePreview.src = res.bw_image_url + cacheBuster; 
          lineartImagePreview.style.display = 'block';
          vectorImagePreview.src = res.comparison_url + cacheBuster; 
          vectorImagePreview.style.display = 'block';
          processingStep2.style.display = 'block';
          setStatus('idle', res.message || 'Ready for Step 2'); 
          showToast('Processing complete! Select parameters.');
      } else if (res.status === 'error') {
          stopDfcallPolling();
          setStatus('idle', res.message || 'Process failed');
          showToast('Process failed');
      }
  }, 1000); 
}
function stopDfcallPolling() {
    if (dfcallPollIntervalId) { clearInterval(dfcallPollIntervalId); dfcallPollIntervalId = null; }
}

selectParamBtn.addEventListener('click', async () => {
    const choice = parseInt(paramChoiceInput.value);
    if (isNaN(choice) || choice < 1 || choice > 5) { showToast('Please enter a number between 1 and 5.'); return; }
    processingStep3.style.display = 'none';
    setStatus('processing', 'Generating paths (Step 2/3)...');
    addLog(`User selected parameter choice: ${choice}. Generating paths...`);
    showToast('Generating paths and all_steps...');
    const res = await apiPost('/select_parameters', { choice_index: choice - 1 });
    if (res?.status?.includes('success')) {
        addLog('Path generation success. Ready to draw.');
        const cacheBuster = `?t=${Date.now()}`;
        vectorImagePreview.src = res.lineart_url + cacheBuster;
        processingStep3.style.display = 'block';
        startContourInput.value = 1;
        startContourInput.max = res.total_contours;
        totalContoursLabel.textContent = `(Total: ${res.total_contours} contours)`;
        setStatus('idle', res.message || 'Ready for Step 3');
        showToast('Paths generated! Ready to draw.');
    } else {
        setStatus('idle', res.message || 'Path generation failed');
        addLog('Path generation failed: ' + (res.message || JSON.stringify(res)));
        showToast('Path generation failed');
    }
});

drawBtn.addEventListener('click', async () => {
  if (drawBtn.disabled) return;
  const startContour = parseInt(startContourInput.value);
  const maxContour = parseInt(startContourInput.max || 1);
  if (isNaN(startContour) || startContour < 1 || startContour > maxContour) {
      showToast(`Error: Start contour must be between 1 and ${maxContour}`); return;
  }
  resetProgress(); 
  setStatus('drawing', 'Starting drawing...');
  addLog('Start drawing requested'); 
  drawingStartTime = Date.now();
  
  const body = {
    start_contour: startContour,
    speed: Number(document.getElementById('speedInput').value),
    pen_offset: Number(document.getElementById('penOffsetInput').value),
    safety_height: Number(document.getElementById('safetyHeightInput').value)
  };
  
  const res = await apiPost('/start_drawing', body);
  if (res.status?.includes('success')) {
    addLog('Backend started drawing: ' + (res.message || ''));
    startDrawingPolling(); 
  } else {
    setStatus('idle', res.message || 'Start drawing failed');
    addLog('Start drawing failed: ' + (res.message || JSON.stringify(res)));
    showToast('Start drawing failed');
  }
});

async function fetchDrawingProgressOnce() { 
  try {
    const r = await fetch('/progress', {cache: 'no-store'});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return await r.json();
  } catch (err) {
    addLog('Progress fetch error: ' + err.message);
    setStatus('disconnected', 'Connection lost');
    stopDrawingPolling();
    return null;
  }
}

async function startDrawingPolling() { 
  if (pollingIntervalId) clearInterval(pollingIntervalId);
  pollingIntervalId = setInterval(async () => {
    const d = await fetchDrawingProgressOnce();
    if (d) updateProgressFromServer(d);
  }, 750); 
}
function stopDrawingPolling() { 
    if (pollingIntervalId) { clearInterval(pollingIntervalId); pollingIntervalId = null; } 
}

function updateProgressFromServer(d) {
  if (currentStatus !== d.status && !(d.status === 'idle' && d.progress < 100)) {
    setStatus(d.status, d.message);
  }
  showProgress(d.progress || 0, d.message || 'Drawing');
  if (d.progress_image_url) {
      const newImageUrl = d.progress_image_url;
      if (vectorImagePreview.src !== newImageUrl) {
          vectorImagePreview.src = newImageUrl; 
          vectorImagePreview.style.display = 'block';
      }
  }
  if (d.status === 'idle' || d.status === 'error') {
    stopDrawingPolling(); 
    if (d.progress >= 100) {
        addLog(`Drawing finished. Status: ${d.message}`);
        showToast(d.message);
    } else if (d.status === 'error') {
        addLog(`Backend error: ${d.message}`);
        showToast(`Error: ${d.message}`);
    } else {
        addLog(`Drawing terminated. Status: ${d.message}`);
        showToast(d.message);
    }
    setStatus('idle', d.message);
  }
}

pauseBtn.addEventListener('click', async () => {
  addLog('Pause requested');
  const res = await apiPost('/pause');
  if (res.status?.includes('success')) { showToast('Paused'); } 
  else { addLog('Pause failed: ' + (res.message||'')); showToast('Pause failed'); }
});
resumeBtn.addEventListener('click', async () => {
  addLog('Resume requested');
  const res = await apiPost('/resume');
  if (res.status?.includes('success')) { showToast('Resumed'); } 
  else { addLog('Resume failed: ' + (res.message||'')); showToast('Resume failed'); }
});
stopBtn.addEventListener('click', async () => {
  addLog('Stop requested');
  const res = await apiPost('/stop');
  if (res.status?.includes('success')) {
    setStatus('processing', 'Stopping...'); 
    addLog('Stop signal sent. Waiting for Dobot to halt...'); 
    showToast('Stopping...');
  } else { addLog('Stop failed: ' + (res.message||'')); showToast('Stop failed'); }
});

document.getElementById('clearLogBtn').addEventListener('click', clearLog);
document.getElementById('downloadLogBtn').addEventListener('click', downloadLog);

// --- Initial State ---
setStatus('disconnected', 'Disconnected');
addLog('Application loaded. Please connect Dobot to begin.');
</script>
</body>
</html>